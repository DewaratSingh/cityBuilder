<html>
  <head>
    <title>City Builder</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <select onchange="tabChange(this)">
      <option value="move">move</option>
      <option value="road">Road</option>
      <option value="PutRect">Put Rect</option>
    </select>

    <script src="uitask.js"></script>
    <script src="vector.js"></script>
    <script src="util.js"></script>
    <script src="road.js"></script>
    <script>
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const camera = { x: 0, y: 0 };
      let mouseDown = false;
      let mousePositionStore = {
        down: {},
        up: {},
        move: { x: 0, y: 0 },
        difference: { x: 0, y: 0 },
      };

      let road = new Road();

      function animation() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        road.draw(ctx, camera, Tab, {
          x: mousePositionStore.move.x - camera.x,
          y: mousePositionStore.move.y - camera.y,
        });
        requestAnimationFrame(animation);
      }
      animation();

      canvas.addEventListener("mousedown", (e) => {
        if (Tab == "road") {
          road.createStartSegment(e.x - camera.x, e.y - camera.y);
        }
        mouseDown = true;
        mousePositionStore.down = { x: e.x, y: e.y };
      });

      canvas.addEventListener("mouseup", (e) => {
        if (Tab == "road") {
          road.createEndSegment(e.x - camera.x, e.y - camera.y);
        }
        mouseDown = false;
        mousePositionStore.up = { x: e.x, y: e.y };
        if (Tab == "move") {
          camera.x =
            e.x - mousePositionStore.down.x + mousePositionStore.difference.x;
          camera.y =
            e.y - mousePositionStore.down.y + mousePositionStore.difference.y;
          mousePositionStore.difference.x = camera.x;
          mousePositionStore.difference.y = camera.y;
        }
      });

      canvas.addEventListener("mousemove", (e) => {
        mousePositionStore.move.x = e.x;
        mousePositionStore.move.y = e.y;
        if (Tab == "road") {
          if (mouseDown) {
            road.createEndSegmentMove(e.x - camera.x, e.y - camera.y);
          }
        }
        if (mouseDown && Tab == "move") {
          camera.x =
            e.x - mousePositionStore.down.x + mousePositionStore.difference.x;
          camera.y =
            e.y - mousePositionStore.down.y + mousePositionStore.difference.y;
        }
      });
    </script>
  </body>
</html>
